# Template file for 'FreeFileSync'
pkgname=FreeFileSync
version=13.5
revision=1
archs="i686 x86_64"
create_wrksrc=yes
build_style=gnu-makefile
hostmakedepends="unzip wget"
makedepends="pkg-config libglib-devel wxWidgets-gtk3-devel libcurl-devel openssl-devel libssh2-devel"
depends="wxWidgets-gtk3 libcurl libssh2 openssl"
short_desc="Backup software to synchronize files and folders"
maintainer="Nicolas Porcel <nicolasporcel06@gmail.com>"
license="GPL-3.0-or-later"
homepage="https://freefilesync.org"
distfiles="${homepage}/download/${pkgname}_${version}_Source.zip"
checksum=f00b7c4286c0411da64271631523d3904bb198ff4cf2020d3f4a87dbc277ca76
fetch_cmd="wget"

CXXFLAGS="-DMAX_SFTP_READ_SIZE=30000 -DMAX_SFTP_OUTGOING_SIZE=30000"

nopie_files="/opt/${pkgname}/Bin/FreeFileSync /opt/${pkgname}/Bin/RealTimeSync"

pre_fetch() {
	# Download the file once to ensure that the file is cached. This is
	# required as the first time the package is downloaded, an html page is
	# returned instead of the download itself.
	wget $distfiles -O /dev/null
}

post_patch() {
	sed -i 's/wx-config/wx-config-gtk3/' FreeFileSync/Source/{,RealTimeSync/}Makefile
}

do_build() {
	make ${makejobs} exeName=FreeFileSync -C FreeFileSync/Source
	make ${makejobs} exeName=RealTimeSync -C FreeFileSync/Source/RealTimeSync
	unzip FreeFileSync/Build/Resources/Icons.zip FreeFileSync.png RealTimeSync.png -d FreeFileSync/Build
}

do_install() {
	vmkdir opt/${pkgname}
	vcopy FreeFileSync/Build/Bin opt/${pkgname}
	vcopy FreeFileSync/Build/Resources opt/${pkgname}

	vmkdir usr/share/pixmaps
	vinstall FreeFileSync/Build/FreeFileSync.png 0644 usr/share/pixmaps
	vinstall FreeFileSync/Build/RealTimeSync.png 0644 usr/share/pixmaps

	vmkdir usr/share/applications
	vinstall ${FILESDIR}/FreeFileSync.desktop 0644 usr/share/applications
	vinstall ${FILESDIR}/RealTimeSync.desktop 0644 usr/share/applications

	vmkdir usr/bin
	ln -s /opt/FreeFileSync/Bin/{FreeFileSync,RealTimeSync} ${DESTDIR}/usr/bin
}
